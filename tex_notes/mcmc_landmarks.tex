\documentclass{article}

% --- Packages --- %
\usepackage{amsmath,amssymb}
\usepackage[margin=2cm]{geometry}

\usepackage{algorithm}
\usepackage[noend]{algpseudocode}

\usepackage{graphicx}
\usepackage{subcaption}

\usepackage{algorithm}
\usepackage[noend]{algpseudocode}

% --- Commands --- %
% Comments
\newcommand{\cjcsays}[1]{{\bfseries Colin says:} \emph{#1}}
\newcommand{\absays}[1]{{\bfseries Andreas says:} \emph{#1}}
\newcommand{\aasays}[1]{{\bfseries Alexis says:} \emph{#1}}

% Maths
\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}
\newtheorem{assumption}{Assumption}
\newtheorem{remark}{Remark}
\newtheorem{proposition}{Proposition}

\newcommand{\pp}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\dede}[2]{\frac{\delta #1}{\delta #2}}
\newcommand{\dd}[2]{\frac{\diff#1}{\diff#2}}

\newcommand{\norm}[2]{\| #1 \|_{ #2 }}
\newcommand{\vnorm}[1]{\norm{ #1 }{V}}
\newcommand{\hnorm}[1]{\norm{ #1 }{H}}
\newcommand{\ltwonorm}[1]{\norm{ #1 }{2}}
\newcommand{\diff}[1]{\text{d} #1}

\newcommand{\Q}{\mathbf{q}}
\newcommand{\U}{\mathbf{u}}
\newcommand{\Z}{\mathbf{z}}
\newcommand{\V}{\mathbf{v}}
\newcommand{\Rd}{\mathbb{R}^{d}}
\newcommand{\RdM}{\mathbb{R}^{d\times M}}

\setlength\parindent{0pt}

\begin{document}
\title{MCMC for selective metamorphosis with applications to landmarks}
\author{Andreas, Alexis and Colin}
\maketitle
\section{Introduction}

In this paper we consider a generalisation of the classical metamorphosis
problem. The purpose of this work is to allow singular control where
metamorphosis occurs in space to allow practitioners in e.g. medical imaging to
qualitatively assess different growth patterns. Owing to this observation we
build a stochastic model on spatial domain and use develop an MCMC algorithm in
order to infer where in space growth is the most likely.\\

This paper is organised as follows. We review some preliminaries in section
\ref{sec:bg}. Next, in section \ref{sec:select_mm} we analyse the problem with
an \emph{a priori} observable function $\nu$ and derive the corresponding
Euler-Lagrange equations for the associated matching functional. Next, section
\ref{sec:bayesian} formalises the Bayesian framework for this problem. This is
then evaluated in section \ref{sec:numerical}.

\subsection{Background}\label{sec:bg}

In this paper we are concerned with diffeomorphometric approaches to image and
shape matching. One of the central pillars on which this field relies is the
observation made by Arnold '66 (cite) that, under certain conditions, a
time-dependent velocity field $u$ occupying some Hilbert space $u_t \in B$
induces a curve on a subgroup $G_B$ of diffeomorphisms \cite{younes2010shapes}
via the following ordinary differential
equation:
\begin{subequations}
\begin{align}
& \dot{\varphi_t} = u_t \circ \varphi_t\\
& \varphi_0 = \text{id}
\end{align}
\end{subequations}
with $\varphi_t \in G_B$, $\forall t$. This allows for the mathematical
(Lagrangian) description of flows on shape and shape spaces.\\

\textbf{$\longrightarrow$ Insert more background here}\\

In the following we let $(V,\vnorm{\cdot})$ and $(H,\hnorm{\cdot})$ be
reproducing kernel Hilbert spaces taking values in $\Rd$. Observe the classical
landmark metamorphosis problem: 

\begin{subequations}
\begin{align}
\inf_{\substack{u\in L^2([0,1],V)\\q,\, z \in L^2([0,1],H)}} & S = \int_0^1
l(u_t, q_t, z_t)\diff{t}\\
    & \dot{q_t} + u_t \cdot \nabla q_t = z_t \\
    & q_j = \hat q_j, \quad j=0,1
\end{align}
\end{subequations}

with $l(u, q, z) = \vnorm{u}^2 + \sigma^2\ltwonorm{z}^2$ and where the boundary
conditions $\hat q_j$ denotes the landmarks for time $j=0,\,1$. $\sigma$
is a parameter controlling the trade-off between the diffeometric and
metamorphosis terms. This matching framework allows singular solutions for
landmarks even in the limit of a large number of landmarks e.g. figure
\ref{fig:classic_mm} where geodesics are allowed to intersect.

\begin{figure}
  \centering
  \includegraphics[width=.4\textwidth]{example-image-a}
  \caption{Something something metamorphosis.}
  \label{fig:classic_mm}
\end{figure}

For landmarks, the velocity field is explicitly expressed in terms of the
momentum and landmarks positions, resulting in a boundary value problem (in
time):
\begin{subequations}
\begin{align}
\dot{q_t} = ...\\
\dot{p_t} = ...
\end{align}
\end{subequations}

\textbf{$\longrightarrow$ Insert segue and motivation for next section here}

\subsection{Selective Metamorphosis}\label{sec:select_mm}

This work aims to place a Bayesian framework on this model in such a way to
allow control of \emph{where} in the domain $\Rd$ to allow transgression of the
usual diffeomorphic constraint $\dot{q_t} = u\circ q_t$. If $\nu=0$, we recover
standard landmark dynamics, if $\nu(x)=\sigma^2$ is a constant, we recover the
classic landmark metamorphosis. That is to say, augmenting the Lagrangian to
constrain metamorphic transformations only in areas of the domain that
correspond to e.g. anatomically interesting places.  This can be expressed
mathematically by changing the Lagrangian above to:
\[
\hat l(u, q, z) = \vnorm{u}^2 +  \nu(q)\ltwonorm{z}^2
\]

where $\Rd\ni x\mapsto\nu (x)$ takes non-negative values in $\mathbb R$. The
goal of this work is to infer the unknown function $\nu$ so as to gather
information about where in the spatial domain we are most likely to observe
metamorphic behaviour via a Bayesian framework introduced in
\cite{stuart_something}.

\begin{remark}[Choice of the form of $\nu$]
Taking $\nu = \sum_k \exp(something)$ we explicitly state at which locations in
space we allow non-diffeomorphic evolution, because when $\nu$ goes to zero we
observe classical smooth dynamics of the landmarks. It could be useful to
develop an algorithm that explores the entire space and infers at which location
in space (if we had to choose only one such location!) it would be best to have
metamorphosis. This could provide a first-order exploratory tool for physicians,
to see if the development of a biological feature stems from a few violations of
diffeomorphic evolution, starting with e.g. an inferred, least-cost,
constellation of $\nu$.\\
On the other hand, if we take $\nu =1 - \sum_k \alpha \exp(.)>0$, we could infer
at which location(s) $x$ in space we require $z_t(x)>0$ in order for the
metamorphosis problem to be solved. In contrast, this choice is natural as a
diagnostic tool instead to infer where in the domain we have growth, which
health experts can attribute biological meaning. This kind of choice allows us
to infer where it is best (i.e. cheapest for the functional) \emph{physically}
\end{remark}

This leads to the following optimisation problem:
\begin{subequations}\label{pbl:selective_mm}
\begin{align}
\inf_{\substack{u\in L^2([0,1],V)\\q,\, z \in L^2([0,1],H)}} & S = \int_0^1
\hat l(u_t, q_t, z_t)\diff{t}\label{nu_fnl}\\
    & \dot{q_t} + u_t \cdot \nabla q_t = z_t \\
    & q_j = \hat q_j, \quad j=0,1
\end{align}
\end{subequations}

In this section we analyse the problem described in \eqref{pbl:selective_mm} for
an a priori known function $\nu$ which we denote \emph{selective metamorphosis
problem}. The first task is to show that the functional attains its infimum,
i.e. identification of a minimiser. Clearly the functional in \eqref{nu_fnl} is
not convex, so we work with a reformulation to ensure the required weak lower
semi-continuity. This comes at the cost of showing weak continuity of the
constraint variables. Specifically, we define a variable $w^i_t = z^i_t
\sqrt{\nu(q_t^i)}$ in the problem:
\begin{subequations}
\begin{align}
\inf_{\substack{u\in L^2([0,1],V)\\m,\, w \in L^2([0,1],H)}} & S =
\int_0^1\vnorm{u}^2 + \sum_i |w_i|^2 \diff{t}\\
    & \dot{m^i_t} = w^i_t {\nu(q_t^i})^{-1/2}\\
    & m^i_j = \text{same as for $q$ above}\quad j=0,1
\end{align}
\end{subequations}

where $m^i_t = q(t, \phi_t)$ so we recover $\dot{m^i_t} = \dot{q^i_t} + u_t
\cdot \nabla q^i_t$ This is the reformulation used in \cite[Theorem
1]{richardson2016metamorphosis}. Now let $(u^{(n)}, w^{(n)}, m^{(n)})$ denote a
minimising sequence. By classic results (see e.g.  Shapes and Diffeomorphisms),
then we can extract bounded subsequences for the velocity and source converging
to weak limits $u$ and $w$ (check this for $w$!). The former implies weak
convergence for the diffeomorphism $\phi$ induced by the velocity. We begin with
the following assumption:
\begin{assumption}
$\|\nu\|_\infty \triangleq \hat \nu <\infty$.
\end{assumption}

Then, omitting the landmark index, we see that\\
\begin{align*}
m_t^{(n)} - m_t & = 
\int_0^1\frac{w_t^{(n)}\circ\phi_t^{(n)}}{\sqrt{\nu\circ q_t^{(n)}\circ\phi_t^{(n)}}}
\diff{t} - \int_0^1\frac{w_t\circ\phi_t}{\sqrt{\nu\circ q_t\circ\phi_t}}
\diff{t}\\
& \leq \int_0^1\frac{w_t^{(n)}\circ\phi_t^{(n)}}{\sqrt{\hat \nu}}
\diff{t} - \int_0^1\frac{w_t\circ\phi_t}{\sqrt{\hat \nu}} \diff{t}\\
\end{align*}

We now invoke \cite[Theorem 1]{richardson2016metamorphosis} to see $m_t^{(n)} -
m_t \rightharpoonup 0$.

\begin{theorem}[Existence]
Statement.\\

{\hfill $\square$}
\end{theorem}

\begin{remark}[Uniqueness]
It is clear that uniqueness is not obtained, as symmetries can elicit several
local minima.
\end{remark}

Extremising the action $S$ we obtain the equations: 
\begin{align}
\dot p_i & = \nabla u(q_i)p_i  + p_i \cdot \nabla \nu(q_i)\\
\dot q & = u(q_i) + \nu(q_i)\\
u(q_j) & = \sum_i K_{ij} p_i
\end{align}

\begin{theorem}[Optimality Conditions]
There exists a unique (? )solution $u, q, z$ to this system.
\end{theorem}

\subsection{Bayesian Framework}\label{sec:bayesian}

We now put a stochastic model on $\nu$. We refer to \dots

This is an appropriate framework because if the lack of uniqueness lends a
qualitative evaluation of what 'solves the optimisation problem'. 

\newcommand{\mhsample}{\textsc{sampleCentroid}}
\newcommand{\acceptprob}{\textsc{acceptanceProbability}}

\begin{algorithm}[h!]
\begin{algorithmic}
\caption{Quasi-MCMC on $\nu$}
\Procedure{quasiMCMC}{$N$}
\State $k \gets 0$
\State $\nu^k \gets \text{ some initial guess}$
\While{$k < N$}
\State $\nu \gets \mhsample ()$\hspace{3cm} \textbf{\# sample a new centroid}
\State $(q, z, u) \gets solveMetamorphosis()$
\If {\textsc{randomUnit()}$\,< \acceptprob(q, z)$}
    \State do update
\Else
    \State don't do update
\EndIf
\State $k\gets k+1$
\EndWhile
\Return $q^k,\, z^k,\, u^k$
\EndProcedure
\end{algorithmic}
\end{algorithm}

Note that the $solveMetamorphosis()$ operation depends on how the spatial domain
is treated. In the next section, we give an example of a particle method leading
to a shooting solution for this operation.

\subsection{Selective Metamorphosis for Landmarks}\label{sec:numerical}

\textbf{$\longrightarrow$ Describe shooting/solution method}\\

\begin{algorithm}[h!]
\begin{algorithmic}
\caption{Metamorphosis for fixed $\nu$}
\Procedure{solveMetamorphosis}{}
\State something either shooting or Firedrake
\EndProcedure
\end{algorithmic}
\end{algorithm}

\textbf{$\longrightarrow$ Something about adjoints here}\\


We present results for five test cases.

%Stuff that works:
%\begin{tabular}{ l c r }
%\text{Test case}   & \beta \text{ (pCN) } & \text{Samples} \\
%\text{Criss-cross} & & \\
%\text{Triangle}    & & \\
%\text{Pringle}     & & \\
%\text{Squeeze}     & 1 & 500
%\end{tabular}

% Insert centroid plot for each test case

% Insert traceplots with highlighted MAP estimators

% Insert Batch plot of 10 running MAP averages

% Insert Autocorrelation plots

\subsection{Outlook}\label{sec:outlook}
Another choice is 
\begin{align}
    l(q,p) = \|u\|_B^2 + \sum_i p_i\cdot \nu(q_i) \, , 
\end{align}
where $\nu:\mathbb R^2 \to \mathbb R^2$, which will give more freedom on the metamorphosis term, and give equations of motion as 
\begin{align}
    \dot p_i  &= \nabla u(q_i)p_i  + p_i \cdot \nabla \nu(q_i)\\
    \dot q &= u(q_i) + \nu(q_i) 
\end{align}

\textbf{What we need to complete:}

\begin{enumerate}
\item Existence and uniqueness of minimisers
\item Existence and uniqueness of the ODEs
\item Well-posedness of the Bayesian formulation
\item Experiments with the tests dumping: Chains (centroid evolution),
traceplots, 10 running batch MAP averages, convergence of the chains
(autocorrelation?)
\item Conclusion
\end{enumerate}

\bibliographystyle{abbrv}
\bibliography{landmarks}

\end{document}
