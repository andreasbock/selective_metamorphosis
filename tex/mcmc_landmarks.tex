\documentclass{article}

% --- Packages --- %
\usepackage{amsmath,amssymb}
\usepackage[margin=2cm]{geometry}

\usepackage{algorithm}
\usepackage[noend]{algpseudocode}

\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{color}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}

% --- Commands --- %
% Comments
\newcommand{\cjcsays}[1]{{\bfseries Colin says:} \emph{#1}}
\newcommand{\absays}[1]{{\bfseries Andreas says:} \emph{#1}}
\newcommand{\aasays}[1]{{\bfseries Alexis says:} \emph{#1}}

% Maths
\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}
\newtheorem{assumption}{Assumption}
\newtheorem{remark}{Remark}
\newtheorem{proposition}{Proposition}

\newcommand{\pp}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\dede}[2]{\frac{\delta #1}{\delta #2}}
\newcommand{\dd}[2]{\frac{\diff#1}{\diff#2}}
\newcommand{\half}{\frac 12}

\newcommand{\norm}[2]{\| #1 \|_{ #2 }}
\newcommand{\vnorm}[1]{\norm{ #1 }{V}}
\newcommand{\hnorm}[1]{\norm{ #1 }{H}}
\newcommand{\ltwonorm}[1]{\norm{ #1 }{2}}
\newcommand{\diff}[1]{\text{d} #1}

\newcommand{\Q}{\mathbf{q}}
\newcommand{\U}{\mathbf{u}}
\newcommand{\Z}{\mathbf{z}}
\newcommand{\V}{\mathbf{v}}
\newcommand{\Rd}{\mathbb{R}^{d}}
\newcommand{\RdM}{\mathbb{R}^{d\times M}}
\newcommand{\nuinf}{\nu_\text{inf}}

\setlength\parindent{0pt}

\begin{document}
\title{MCMC for selective metamorphosis with applications to landmarks}
\author{Andreas, Alexis and Colin}
\maketitle
\section{Introduction}

In this paper we consider a generalisation of the classical metamorphosis
problem. The purpose of this work is to allow singular control where
metamorphosis occurs in space to allow practitioners in e.g. medical imaging to
qualitatively assess different growth patterns. Owing to this observation we
build a stochastic model on spatial domain and use develop an MCMC algorithm in
order to infer where in space growth is the most likely.\\

This paper is organised as follows. We review some preliminaries in section
\ref{sec:bg}. Next, in section \ref{sec:select_mm} we analyse the problem with
an \emph{a priori} observable function $\nu$ and derive the corresponding
Euler-Lagrange equations for the associated matching functional. Next, section
\ref{sec:bayesian} formalises the Bayesian framework for this problem. This is
then evaluated in section \ref{sec:numerical}.

\subsection{Background}\label{sec:bg}

In this paper we are concerned with diffeomorphometric approaches to image and
shape matching. One of the central pillars on which this field relies is the
observation made by Arnold '66 (cite) that, under certain conditions, a
time-dependent velocity field $u$ occupying some Hilbert space $u_t \in V$
induces a curve on a subgroup $G_V$ of diffeomorphisms \cite{younes2010shapes}
via the following ordinary differential
equation:
\begin{subequations}\label{diffeo}
\begin{align}
& \dot{\varphi_t} = u_t \circ \varphi_t\\
& \varphi_0 = \text{id}
\end{align}
\end{subequations}
with $\varphi_t \in G_V$, $\forall t$. This allows for the mathematical
(Lagrangian) description of flows on shape and shape spaces with a rich
literature of applications (cite theory + applications). A unifying property of
these is to use \eqref{diffeo} in defining an optimisation problem:
\[
\min_{t \mapsto \varphi_t} \int_0^1 \half\vnorm{u_t}^2 \diff{t} + \half S(q_0\circ\varphi_1, q_1)
\]
where $S$ denotes a similarity measure and $q_j$, $j=0,1$.

However deformations of manifolds $q_j$ by members of $G_B$ must obey a certain
smoothness, which is ill-suited for arbitrary manifolds e.g. topologically
different ones.

Moreover, metamorphosis is a generalisation thereof and provides more robust
model for performing shape deformation.

\textbf{$\longrightarrow$ Insert more background here}\\

In the following we let $H$ denote a vector space taking values in $\Rd$ to be determined later.
Observe the classical landmark metamorphosis problem:
\begin{subequations}
\begin{align}
\inf_{\substack{u\in L^1([0,1],V)\\q,\, z \in C^1([0,1], H)}} & S = \int_0^1
l(u_t, q_t, z_t)\diff{t}\\
    & \dot{q_t} = u_t \circ q_t + z_t \\
    & q_0,\,q_1\text{ fixed}
\end{align}
\end{subequations}

with $l(u, q, z) = \half \vnorm{u}^2 + \frac{\sigma^2}2 \ltwonorm{z}^2$ and
where the boundary conditions $q_0,\,q_1 \in \RdM$ denotes the landmarks for
time $j=0,\,1$.  $\sigma$ is a parameter controlling the trade-off between the
diffeometric and metamorphosis terms. In LDDMM, the equations are the same but
the boundary conditions are different.  In particular, $q_1$ is not fixed, but
an initial momentum, $p_0$, is imposed to close the system. As we see in figure
\ref{fig:mm_lddmm}, these frameworks lead to different results. Our goal here is
to provide an approach that allows selective delivery of a mix between the
purely diffeomorphic LDDMM approach and the metamorphic matching.

\begin{figure}
\centering
\begin{minipage}{\textwidth}
  \centering
    \includegraphics[width=.2\textwidth]{../src/vanilla_results/mm/mm_criss_cross.pdf}\quad
    \includegraphics[width=.2\textwidth]{../src/vanilla_results/mm/mm_pringle.pdf}\quad
    \includegraphics[width=.2\textwidth]{../src/vanilla_results/mm/mm_squeeze.pdf}\quad
    \includegraphics[width=.2\textwidth]{../src/vanilla_results/mm/mm_triangle_flip.pdf}\\[0.25cm]
    \includegraphics[width=.2\textwidth]{../src/vanilla_results/lddmm/lddmm_criss_cross.pdf}\quad
    \includegraphics[width=.2\textwidth]{../src/vanilla_results/lddmm/lddmm_pringle.pdf}\quad
    \includegraphics[width=.2\textwidth]{../src/vanilla_results/lddmm/lddmm_squeeze.pdf}\quad
    \includegraphics[width=.2\textwidth]{../src/vanilla_results/lddmm/lddmm_triangle_flip.pdf}
    %\subcaption{.}
    \caption{Metamorphosis (top) and LDDMM (bottom).}
    \label{fig:mm_lddmm}
\end{minipage}
\end{figure}

For landmarks, the velocity field is explicitly expressed in terms of the
momentum and landmarks positions, resulting in a boundary value problem (in
time):
\begin{subequations}
\begin{align}
& \dot{q_t} = u(q_t)\\
& \dot{p_t} = - \nabla u(q_t)^T p_t\\
& q_0,\,q_1\text{ fixed}
\end{align}
\end{subequations}

\textbf{$\longrightarrow$ Insert segue and motivation for next section here}

\subsection{Selective Metamorphosis}\label{sec:select_mm}

This work aims to place a Bayesian framework on this model in such a way to
allow control of \emph{where} in the domain $\Rd$ to allow transgression of the
usual diffeomorphic constraint $\dot{q_t} = u\circ q_t$. If $\nu=0$, we recover
standard landmark dynamics, if $\nu(x)=\sigma^2$ is a constant, we recover the
classic landmark metamorphosis. That is to say, augmenting the Lagrangian to
constrain metamorphic transformations only in areas of the domain that
correspond to e.g. anatomically interesting places.  This can be expressed
mathematically by changing the Lagrangian above to:
\[
\hat l(u, q, p) = \half\vnorm{u}^2 + \half\sum_i \nu(q_i)|p_i|^2
\]

where $\Rd\ni x\mapsto\nu (x)$ takes non-negative values in $\mathbb R$. The
goal of this work is to infer the unknown function $\nu$ so as to gather
information about where in the spatial domain we are most likely to observe
metamorphic behaviour via a Bayesian framework as in \cite{dashti2017bayesian}.

\begin{remark}[Choice of the form of $\nu$]
Taking e.g. $\nu(\cdot) = \sum_k \exp(-h(\cdot))$ for some function $h>0$ we
explicitly state at which locations in space we allow non-diffeomorphic
evolution, because when $\nu$ goes to zero we observe classical smooth dynamics
of the landmarks.  It could be useful to develop an algorithm that explores the
entire space and infers at which location in space (if we had to choose only one
such location!) it would be best to have metamorphosis. This could provide a
first-order exploratory tool for physicians, to see if the development of a
biological feature stems from a few violations of diffeomorphic evolution,
starting with e.g. an inferred, least-cost, constellation of $\nu$.\\

On the other hand, if we take $\nu(\cdot) = 1 - \sum_k \alpha
\exp(-h(\cdot))>0$, we could infer at which location(s) $x$ in space we require
$z_t(x)>0$ in order for the metamorphosis problem to be solved. In contrast,
this choice is natural as a diagnostic tool instead to infer where in the domain
we have growth, which health experts can attribute biological meaning. This kind
of choice allows us to infer where it is best (i.e. cheapest for the functional)
\emph{physically}.
\end{remark}

\begin{subequations}\label{pbl:selective_mm}
\begin{align}
\inf_{\substack{u \in L^1([0,1],V)\\ q, p\, \in C^1([0,1],\RdM)}} & S = \int_0^1 \hat l(u_t, q_t, p_t)\diff{t}\label{nu_fnl}\\
& \dot{q_t^i} =  u(q_t^i) + \nu(q^i_t)p^i_t \\
    & q_0,\,q_1\text{ fixed}
\end{align}
\end{subequations}
In this section we analyse the problem described in \eqref{pbl:selective_mm} for
an a priori known function $\nu$ which we denote \emph{selective metamorphosis
problem}. The first task is to show that the functional attains its infimum,
i.e. identification of a minimiser. We begin with the following assumption:
\begin{assumption}\label{assumption:nu_bounded}
$\|\nu\|_\infty \triangleq \sigma^2 <\infty$ and $\nu$ is bounded from below
away from zero by $\nuinf \in \mathbb R$.
\end{assumption}
Since the limit as $\nu\rightarrow 0$ is well-understood these assumptions do
not constitute large concessions. Clearly the functional in \eqref{nu_fnl} is
not convex, so we work with a reformulation to ensure the required weak lower
semi-continuity. This comes at the cost of showing weak continuity of the
constraint variables. Specifically, we define a variable $z^i_t = p^i_t
\sqrt{\nu(q_t^i)}$ in the problem:
\begin{subequations}\label{pbl:reformulation}
\begin{align}
\inf_{\substack{u \in L^2([0,1],V)\\ q, z\, \in L^2([0,1],\RdM)}}
    & S = \int_0^1 \half\vnorm{u_t}^2 + \half\sum_i |z_t^i|^2 \diff{t}\\
    & \dot{q_t^i} = u(q_t^i) + \sqrt{\nu(q_t^i)} z^i_t\\
    & q_0,\,q_1\text{ fixed}
\end{align}
\end{subequations}

We now show existence of a minimiser to this problem. First, note that owing to
the constraint effectively being a boundary value problem, we cannot always find
a $q$ for arbitrary pairs of $(u,\,z)$. We define an bounded operator $(q,u)\mapsto
\frac{\dot{q} - u(q)}{\sqrt{\nu(q)}} \triangleq z$:
\begin{align*}
\ltwonorm{z}^2 & = \ltwonorm{\frac{\dot{q} - u(q)}{\sqrt{\nu(q)}}}^2\\
& \leq \nuinf^{-1}\Big(\ltwonorm{\dot{q}}^2 + \ltwonorm{u(q)}^2\Big)\\
\end{align*}
which is clearly bounded since $q\in C^1(0,1,H)$ and since by continuity of $u$.
From this we generate a minimising sequence $(q^n, u^n, z^n)$ admissible to
\eqref{pbl:reformulation}.\\

\textbf{$\longrightarrow$ Show weak continuity of the constraint equation for
$q$ (the stuff below)}\\

Passing to subsequences where necessary we can by classic results
\cite{younes2010shapes} extract bounded subsequences converging to weak limits
where necessary. By convexity of $S$ we have therefore proved the following:

\begin{theorem}
Assumption \ref{assumption:nu_bounded} implies that the problem
\eqref{pbl:reformulation} attains its unique infimum.
{\hfill $\square$}
\end{theorem}

We now derive the optimality conditions of \eqref{pbl:reformulation}.
Using $p_t^i$ as a Lagrange multiplier and extremising $J$ leads to the
following equations:

\begin{subequations}\label{pbm:nonlinear_inner:optimality}
\begin{align}
& \dot{p_t^i} + \nabla u(q_t^i) p_t^i + \half \nabla \nu(q_t^i) |p_t^i|^2 = 0\\
& \dot{q_t^i} = u(q_t^i) + \nu(q_t^i) p^i_t\\
& q_0,\,q_1\text{ fixed}
\end{align}
\end{subequations}

In this paper we are concerned only with
landmarks, so we can write the Lagrangian in terms of the state variables $\hat
l(q, z) = \hat l(u, q, z)$ \cite{younes2010shapes}:
\begin{align*}
\vnorm{u}^2 = \sum_{i,j=0}^M K(q^i,q^j) p^i \cdot p^j
\end{align*}

where supercripts denote the landmark index. 
%\inf_{\substack{u \in L^2([0,1],V)\\ q, z\, \in L^2([0,1],\RdM)}}
    %& S = \int_0^1\sum_{i,j=0}^M K(q_t^i,q_t^j)
  %& \dot{q_t^i} = \sum_{j=0}^M K(q_t^j, q_t^i)p_t^i + \sqrt{\nu(q_t^i)} z^i_t\\

Extremising the action $S$ we obtain the equations: 
\begin{align}\label{pq:optimality}
& \dot p_i =\frac12 \sum_j \nabla K(q_i,q_j)p_i\cdot p_j  + \frac12 |p_i|^2 \nabla \nu(q_i)\\
& \dot q_i = \sum_j K(q_i,q_j)p_i + \nu(q_i)p_i\\
& q_0,\,q_1\text{ fixed}
\end{align}

\begin{theorem}[Optimality Conditions]
There exists a unique (? )solution $u, q, z$ to this system.

This will give more conditions on $\nu$, like $\nu(x) \in C^{1}(\mathbb R^2)$. 
\end{theorem}

\subsection{Bayesian Framework}\label{sec:bayesian}

We now place a stochastic model on $\nu$, the purpose of which depends on its
definition. First we present some preliminaries on the Bayesian approach to
inverse problems. We rely heavily on the results of \cite{dashti2017bayesian}.
See also (the one by SL Cotter).\\

% General setting
Our setting is the following. Consider a potential $\Phi(y)$ 

We now introduce the main problem of this paper in the setting above. We
consider $\nu$ as a random variable, indeed a random \emph{function}, occupying
some space yet to be determined. The \\

Indeed, if $\nu$ is set as some kind of exponential, then we
see that 
the purpose of which is to infer at
which points in the spatial domain it is most likely to allow metamorphosis.
%
%This is an appropriate framework because if the lack of uniqueness lends a
%qualitative evaluation of what 'solves the optimisation problem'.

\begin{equation}\label{finite_dim_nu}
	\nu(x) = \sum_k^N a_k \nu_k(x)
\end{equation}
for a basis $(\nu_k)_{k=0}^\infty$ of $\mathcal D \in \mathbb R^2$, truncated at $k=N$.  

\begin{align}
	\Phi(a_k) = S(\nu,q_0,q_1) + |\nu|_V^2
\end{align}
where, for example $ V = {L_2(\mathcal D)}$. 

\begin{itemize}
	\item MAP exists
	\item Radon-Nikodyn derivative exists
	\item Continuity of the posterior w.r.t the initial data 
\end{itemize}

\newcommand{\mhsample}{\textsc{sampleCentroid}}
\newcommand{\acceptprob}{\textsc{acceptanceProbability}}

\begin{algorithm}[h!]
\begin{algorithmic}
\caption{Quasi-MCMC on $\nu$}\label{algo:mcmc}
\Procedure{quasiMCMC}{$N$}
\State $k \gets 0$
\State $\nu^k \gets \text{ some initial guess}$
\While{$k < N$}
\State $\nu \gets \mhsample ()$\hspace{3cm} \textbf{\# sample a new centroid}
\State $(q, z, u) \gets solveMetamorphosis()$
\If {\textsc{randomUnit()}$\,< \acceptprob(q, z)$}
    \State do update
\Else
    \State don't do update
\EndIf
\State $k\gets k+1$
\EndWhile
\Return $q^k,\, z^k,\, u^k$
\EndProcedure
\end{algorithmic}
\end{algorithm}

Note that the $solveMetamorphosis()$ operation, in general, depends on how the
spatial domain is treated e.g. whether we use landmarks or treat full images.
In this paper we are only concerned with the former, so we use a standard and
easily implemented procedure (cite) below 

\textbf{$\longrightarrow$ Describe shooting/solution method}\\
\begin{algorithm}[h!]
\begin{algorithmic}
\caption{Metamorphosis for fixed $\nu$}
\Procedure{solveMetamorphosis}{}
\State something either shooting or Firedrake
\EndProcedure
\end{algorithmic}
\end{algorithm}

\textbf{$\longrightarrow$ Something about adjoints here}\\

\subsection{Selective Metamorphosis for Landmarks}\label{sec:numerical}

This penultimate section displays some numerical results for our method. First,
as a proof of concept 
%Stuff that works:
%\begin{tabular}{ l c r }
%\text{Test case}   & \beta \text{ (pCN) } & \text{Samples} \\
%\text{Criss-cross} & & \\ <-- CENTROID
%\text{Triangle}    & & \\
%\text{Pringle}     & & \\
%\text{Squeeze}     & 1 & 500 <-- CENTROID
%\end{tabular}

As we have seen in figure \ref{fig:classic_mm}, classic metamorphosis is an
appropriate model for non-diffeomorphic matching. We now evaluate our stochastic
model described in algorithm \ref{algo:mcmc} to the landmark configurations in
\ref{fig:classic_mm}. For the pinching and crossing geodesics, figure X and Y,
we consider the simplest case where we can parameterise $\nu$ by a finite family
$h_k$ of fields in $\Rd$. We denote these the \textit{centroids}. Specifically,
we define \begin{equation} \nu_h (x) \triangleq \sum_k e^{-\|h_k - x\|_{\Rd}^2}
\end{equation}

\begin{figure}
\centering
\begin{minipage}{\textwidth}
  \centering
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\\[0.25cm]
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}
    %\subcaption{.}
    \caption{Selective metamorphosis for the pinch example. The top row displays
    the geodesics corresponding a sample realisation from the chain, centroid
    heat map with four MAP estimators, functional histogram and autocorrelation
    plot. The bottom row shows the geodesics for four MAP estimators.}
    \label{fig:selective:pinch}
\end{minipage}
\end{figure}

\textbf{$\longrightarrow$ Explain results}\\

\begin{figure}
\centering
\begin{minipage}{\textwidth}
  \centering
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\\[0.25cm]
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}
    %\subcaption{.}
    \caption{Selective metamorphosis for the inverted landmarks example. The top
    row displays the geodesics corresponding a sample realisation from the
    chain, centroid heat map with four MAP estimators, functional histogram and
    autocorrelation plot. The bottom row shows the geodesics for four MAP
    estimators.}
    \label{fig:selective:crossing}
\end{minipage}
\end{figure}

% Insert Effective Sample size (if time)
We note that since the Euler-Lagrange equations for $p$ and $q$ are
time-reversible, the configuration in \ref{something} both lead to a notion of
collapse and hole creation for the landmarks.\\

\begin{figure}
\centering
\begin{minipage}{\textwidth}
  \centering
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\\[0.25cm]
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}
    %\subcaption{.}
    \caption{Selective metamorphosis for the inverted landmarks example The top
    row displays the geodesics corresponding a sample realisation from the
    chain, centroid heat map with four MAP estimators, functional histogram and
    autocorrelation plot. The bottom row shows the geodesics for four MAP
    estimators.}
    \label{fig:selective:crossing}
\end{minipage}
\end{figure}


\begin{figure}
\centering
\begin{minipage}{\textwidth}
  \centering
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\\[0.25cm]
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}
    %\subcaption{.}
    \caption{Selective metamorphosis for the inverted landmarks example The top
    row displays the geodesics corresponding a sample realisation from the
    chain, centroid heat map with four MAP estimators, functional histogram and
    autocorrelation plot. The bottom row shows the geodesics for four MAP
    estimators.}
    \label{fig:selective:crossing}
\end{minipage}
\end{figure}

We note that the source code for all of these experiments is documented
here (insert link to github.io). 

\subsection{Outlook}\label{sec:outlook}
Another choice is 
\begin{align}
    l(q,p) = \|u\|_B^2 + \sum_i p_i\cdot \nu(q_i) \, , 
\end{align}
where $\nu:\mathbb R^2 \to \mathbb R^2$, which will give more freedom on the metamorphosis term, and give equations of motion as 
\begin{align}
    \dot p_i  &= \nabla u(q_i)p_i  + p_i \cdot \nabla \nu(q_i)\\
    \dot q &= u(q_i) + \nu(q_i) 
\end{align}

Future work also includes extending this framework to images e.g. using the
kernel framework in \cite{richardson2016metamorphosis}, or developing a
space-time method. Formalising the measure-theory necessary to consider the
limit of \eqref{finite_dim_nu} as $k\rightarrow\infty$.

Moreover, adding a time-dependency to $\nu$ is also to be
explored. It is our hope that we can extend the theory developed here to
encompass classic metamorphosis; that is to say, to develop the necessary theory
in order to place a stochastic model on the state space consisting of
velocities and source functions. Being able to sample random pairs (MCMC) of these
would permit a novel numerical approach to metamorphosis as well as other
problems shape analysis.

\bibliographystyle{abbrv}
\bibliography{landmarks}

\end{document}
