% This is samplepaper.tex, a sample chapter demonstrating the
% LLNCS macro package for Springer Computer Science proceedings;
% Version 2.20 of 2017/10/04
%
\documentclass[runningheads]{llncs}
%
\usepackage{color}
\usepackage{graphicx}
\usepackage{subfigure}
\usepackage{braket}
\usepackage[final]{fixme}
\usepackage{amsmath,amsfonts}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\usepackage{appendix}

\newcommand{\pp}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\dede}[2]{\frac{\delta #1}{\delta #2}}
\newcommand{\dd}[2]{\frac{\diff#1}{\diff#2}}
\newcommand{\half}{\frac 12}

\newcommand{\norm}[2]{\| #1 \|_{ #2 }}
\newcommand{\vnorm}[1]{\norm{ #1 }{V}}
\newcommand{\hnorm}[1]{\norm{ #1 }{H}}
\newcommand{\ltwonorm}[1]{\norm{ #1 }{2}}
\newcommand{\diff}[1]{\text{d} #1}

\newcommand{\Q}{\mathbf{q}}
\newcommand{\U}{\mathbf{u}}
\newcommand{\Z}{\mathbf{z}}
\newcommand{\V}{\mathbf{v}}
\newcommand{\Rd}{\mathbb{R}^{d}}
\newcommand{\RdM}{\mathbb{R}^{d\times M}}
\newcommand{\RdK}{\mathbb{R}^{d\times K}}
\newcommand{\nuinf}{\nu_\text{inf}}

\newtheorem{assumption}{Assumption}

% Used for displaying a sample figure. If possible, figure files should
% be included in EPS format.
%
% If you use the hyperref package, please uncomment the following line
% to display URLs in blue roman font according to Springer's eBook style:
% \renewcommand\UrlFont{\color{blue}\rmfamily}

\begin{document}
%
\title{MCMC for selective metamorphosis with applications to landmarks}
%
%\titlerunning{Abbreviated paper title}
% If the paper title is too long for the running head, you can set
% an abbreviated paper title here
%
\author{Andreas Bock\inst{1} \and  Alexis Arnaudon\inst{1} \and Colin Cotter\inst{1}}
%
\authorrunning{Bock et al.}
% First names are abbreviated in the running head.
% If there are more than two authors, 'et al.' is used.
%
\institute{Imperial College London}
%\email{lncs@springer.com}\\
%\url{http://www.springer.com/gp/computer-science/lncs} \and
%ABC Institute, Rupert-Karls-University Heidelberg, Heidelberg, Germany\\
%\email{\{abc,lncs\}@uni-heidelberg.de}}
%
\maketitle              % typeset the header of the contribution

\begin{abstract}


\keywords{LDDMM \and MCMC \and Metamorphosis.}
\end{abstract}

\section{Introduction}

In computational anatomy
\cite{grenander1994representations,grenander1998computational}, one of the most
fundamental problem is to continuously deform an image, or shape into another
and thereby obtain a natural notion of distance between them, from the energy
required for this deformation.  These distances can then be used for image
registration, atlas construction, etc\dots see \cite{todo} for more
applications. On of the most common method to compute image deformations is
based on the notion of diffeomorphic deformations which assume that the images
are continuously deformed into one another with the additional property that the
inverse deformation is also continuous.  This is a strong requirement for images
which implies that the 'mass' of any part of the image is conserved: we cannot
create or close 'holes'.  This property is also a crucial property of fluid
mechanics, and in fact, the theory of diffeomorphic matching carrying the
moniker \emph{Large Deformation Diffeomorphic Metric Mapping}
\cite{trouve1998diffeomorphisms,beg2005computing} (LDDMM) has been inspired by
fluid mechanics. Indeed, one of the central pillars on which this field relies
is the observation made by Arnold \cite{arnold1966geometrie} that the geodesic
equations for the diffeomorphism group induced by divergence-free vector fields
corresponded to that of incompressible flows. See also ({\color{red} Refs of
Darryl, etc\dots.}{\color{green} Not too sure which fluids papers to reference
here!}) 

If a strictly diffeomorphic matching is not necessary, an extension of LDDMM
called metamorphosis \cite{trouve2005metamorphoses,holm2009euler} is available
which introduces a parameter $\sigma^2$ parametrizing the deviation from
diffeomorphic matching.  In particular, if $\sigma^2=0$, metamorphosis reduces
to LDDMM.  See \cite{trouve1995infinite,trouve2005local,miller2001group} for
technical details pertaining to constructing the metamorphosis problem.  While
diffeomorphic paths always exists for landmark problems
\cite{guo2006diffeomorphic} this theory allows one to match images of shapes
with different topological features, which is ill-conditioned for standard
LDDMM. Indeed, even for if we allow inexact matching in LDDMM, the image
deformation will have to be close to the limit of the diffeomorphic matching,
yielding a large and uncertain energy for the matching, thus a useless notion of
distance between images. The incertainty comes from the fact that for inexact
matching, several almost trajectories of deformations can be computed, but with
different energies.  Introducing the metamorphosis parameter $\sigma^2$ will
stabilize this matching problem at the cost of breaking the diffeomorphic
property on the whole image, or shape, and at all time in the deformation. 

In this work, we modify the original metamorphosis problem to include an image
dependent metamorphosis parameter $\nu(x)$ in order to obtain an almost
diffeomorphic matching, but without the energy or inexact matching problem, see
figure \ref{fig:mm_lddmm}.  If $\nu(x) = \sigma^2$, our theory will reduces to
the standard metamorphosis model, but with a localised $\nu(x)$, we can
selectively introduce metamorphosis on an image and model local topological
effects, such as hole creation or annihilation.  The difficulty of this problem
is to infer the function $\nu(x)$ without a priory knowledge of the location of
the topological effects.  We will use a Markov chain approach to infer good
functions $\nu(x)$, such that the topological effects are well described and a
large part of the matching remains diffeomorphic.  For this paper, we will focus
on landmark matching, but the theory of selective metamorphosis can be extended
to any data structures that the classical metamorphosis of LDDMM theory can
handle, see {\color{red} cite next paper in preparation!}. 


\begin{figure}
\centering
\begin{minipage}{\textwidth}
  \centering
    \includegraphics[width=.3\textwidth]{lddmm_criss_cross.pdf}\quad
    \includegraphics[width=.3\textwidth]{lddmm_squeeze.pdf}\quad
    \includegraphics[width=.3\textwidth]{lddmm_triangle_flip.pdf}\\[0.25cm]
    \includegraphics[width=.3\textwidth]{mm_criss_cross.pdf}\quad
    \includegraphics[width=.3\textwidth]{mm_squeeze.pdf}\quad
    \includegraphics[width=.3\textwidth]{mm_triangle_flip.pdf}\\[0.25cm]
    \includegraphics[width=.3\textwidth]{mm_criss_cross.pdf}\quad
    \includegraphics[width=.3\textwidth]{mm_squeeze.pdf}\quad
    \includegraphics[width=.3\textwidth]{mm_triangle_flip.pdf}
    \caption{This figures illustrates landmark matching with classical LDDMM
    (top row), metamorphosis (bottom row) and selective metamorphosis (middle
    row).  We chose difficult matching for LDDMM, and we observe unrealistic
    landmark trajectories, with large resulting energies, or distances, whereas
    the metamorphosis  matching results in a more realistic landmark
    trajectories.  The selective metamorphosis has the extra advantage of only
    breaking the diffeomorphic property where needed in along the matching, thus
    preserving more of the desired diffeomorphic property of the matching.
    {\color{red} Add the middle row with position of $\nu$ fields as crosses,
    and value of the energy functional for each (larger for top and middle
    row)}}
    \label{fig:mm_lddmm}
\end{minipage}
\end{figure}

%In this paper we consider a generalisation of the classical metamorphosis
%problem. The purpose of this work is to allow singular control where
%metamorphosis occurs in space to allow practitioners in e.g. medical imaging to
%qualitatively assess different growth patterns. Owing to this observation we
%build a stochastic model on spatial domain and use develop an MCMC algorithm in
%order to infer where in space growth is the most likely.\\

{\bf Structure} This paper is organised as follows. We review the theory of
classical metamorphosis in section \ref{sec:bg} and extend it to selective
metamorphosis in \ref{sec:select_mm}.  We then introduce a Bayesian framework
for inferring the local metamorphosis parameter $\nu(x)$ in section
\ref{sec:bayesian} and apply this theory to a few landmark examples in section
\ref{sec:numerical}.

\section{Metamorphosis with landmarks}\label{sec:bg}

In this paper we are concerned with diffeomorphometric approaches to image and
shape matching. One of the central pillars on which this field relies is the
observation made by Arnold \cite{arnold1966geometrie} that, under certain
conditions, a time-dependent velocity field $u$ e.g. occupying some Hilbert
space $u_t \in V$ induces a curve on a subgroup $G_V$ of diffeomorphisms
\cite{younes2010shapes} via the following ordinary differential equation
\begin{align}
& \dot{\varphi_t} = u_t \circ \varphi_t\, , \qquad  \varphi_0 = \text{id}
  \label{diffeo}
\end{align}
with $\varphi_t \in G_V$, $\forall t$ and $u_t$ is a time-dependent vector
field, obtained by minimising the following energy
\begin{align}
  E(u) = \int_0^1 \half\vnorm{u_t}^2 \diff{t}Â + \frac{1}{\sigma^2}
  S(I_0\circ\varphi_1, I_1)\, , \label{E-def}
\end{align}
where $S$ denotes a similarity measure or norm between the deformed initial
image $I_0\circ \varphi_1$ and the target image $I_1$ to allow inexact matching
parametrised by $\sigma^2$. The LDDMM) approach takes $S$ as an $L^2$ norm on the difference between
its arguments.
In the sequel, we will set $\lambda=0$ such that we
only consider exact matching, the hardest problem to solve, especially for
images non-topologically equivalent, as discussed in the introduction, see also
Fig. \ref{fig:mm_lddmm}.


In order to simplify the exposition, we will consider singular solutions of this
problem, which are given by \begin{align}
  \frac{\delta l}{\delta u} = m(x) = \sum_i p_i \delta(x-q_i)\,, 
\end{align}
for $N$ landmarks with position $q_i\in \mathbb R^2 $ and momenta $p_i \in \mathbb R^2$. 
The vector field is thus 
\begin{align}
  u(x) = \sum_i p_i K(x-q_i)\,, 
  \label{u-def}
\end{align}
where $K:\mathbb R^2\times \mathbb R^2\to \mathbb R$ is the kernel associated to
the norm $\|\cdot \|_V$.  For metamorphosis, we introduce a discrete template
variable $\boldsymbol \eta_t$ such that the deformation of a set of landmarks is
written as the composition of the template position and deformation as
\begin{align}
  \mathbf q_t = \varphi_t \boldsymbol \eta_t\, . 
  \label{q_t}
\end{align}
Then, we can define the template velocity as 
\begin{align}
  \mathbf z = \varphi_t \dot {\boldsymbol \eta}
  \label{z_eta}
\end{align}
and extend the energy \eqref{E-def} to 
\begin{align}
  \begin{split}
    E_m(\mathbf q_t, \mathbf p_t, \mathbf z_t) = & \int_0^1
    \half  \left (\vnorm{u_t}^2 + \frac{1}{\sigma^2} \sum_{i=1}^M |z_t^i|^2\right )\diff{t}
  \end{split}
  \label{E_m-def}
\end{align}
where now the reconstruction relation is 
\begin{align}
    \dot{\mathbf q_t} = u_t (\mathbf q_t) + \mathbf z_t\, , 
    \label{dq-m}
\end{align}
obtained from \eqref{z_eta} and \eqref{q_t} together with  $u= \dot \varphi_t \varphi^{-1}$, 
see \cite{holm2009euler} for more details.  
Before, the boundary conditions are given on the positions $\mathbf q(0)$ and $\mathbf
q(1)$, but we now have an extra term in the energy and the reconstruction
equation \eqref{dq-m}. 

By taking variations carefully, see again \cite{holm2009euler}, we directly obtain 
\begin{align}
  \mathbf m(x) = \frac{1}{\sigma^2} \sum_i z_i\delta(x-q_i)\qquad \Rightarrow \qquad
  \mathbf z = \sigma^2 \mathbf p_i\, , 
\end{align}
and the equation of motions are
\begin{align}
  \begin{split}
  \dot{\mathbf p_t} &= - \nabla u_t(\mathbf q_t)^T \mathbf p_t\\ 
  \dot{\mathbf q_t} &= u_t(\mathbf q_t) +  \sigma^2\mathbf p_t \,,
  \end{split}
  \label{eq-m-classic}
\end{align}
where $u_t$ is defined in \eqref{u-def}. 

\section{Selective Metamorphosis for Landmarks}\label{sec:select_mm}

We can now extend the metamorphosis setting to be able to locally control the
amount of non-diffeomorphic evolution.  For this, we introduce a function $\nu:
\mathbb R^2\to \mathbb R$ replacing the parameter $\sigma^2$ such that
$\nu(x)=\sigma^2$ corresponds to the classic landmark metamorphosis.
We thus choose to minimise the following energy functional:
\begin{align}
  \begin{split}
    E_{sm}^\nu(\mathbf q_t, \mathbf p_t, \mathbf z_t) = & \int_0^1
    \half  \left (\vnorm{u_t}^2 +\sum_{i=1}^M \frac{1}{\nu(q_t^i)}|z_t^i|^2\right )\diff{t}
  \end{split}
  \label{E_sm-def}
\end{align}
subject to the reconstruction equation \eqref{dq-m}. We have, as before that
\begin{align}\label{zp_relation}
  \mathbf m(x) =  \sum_i \frac{1}{\nu(q_i)} z_i\delta(x-q_i)\qquad \Rightarrow \qquad
  z_i = \nu(q_i) p_i\quad \forall i\, , 
\end{align}
so we can get rid of the template variable $\mathbf z_t$ and write. 
\begin{align}
  \begin{split}
    E_{sm}^\nu(\mathbf q_t, \mathbf p_t) = & \int_0^1
    \half  \left (h_l(\mathbf q_t,\mathbf p_t)  +\sum_{i=1}^M \nu(q_t^i)|p_t^i|^2\right )\diff{t}\, , 
  \end{split}
  \label{E_sm-def_p}
\end{align}
for the standard landmark Hamiltonian
\begin{align}
  h_l(\mathbf q, \mathbf p) =  \frac12 \sum_{i,j}K(q_i-q_j)p_i\cdot p_j\, . 
\label{hamiltonian}
\end{align}
We show that the optimisation problem \eqref{E_sm-def} is well-posed. First, we
need the assumption
\begin{assumption}\label{assumption:nu_bounded}
  $\mathrm{max}_\mathcal{D}(\nu) = \nu_m < \infty$ %and $\nu$ is bounded from below
%away from zero by $\nuinf \in \mathbb R$.
\end{assumption}

\begin{theorem}\label{sm-eu}
Assumption \ref{assumption:nu_bounded} implies that the problem
\eqref{pbl:reformulation} attains its unique infimum.\\

Proof: See appendix \ref{app:proof:sm-eu}.
{\hfill $\square$}
\end{theorem}
{\color{red} I think we don't need $\nu>0$, using the $p$ variable it is fine to have $\nu=0$ on some subset of the domain $\mathcal D$, or even the whole domain is we don't want metamorphosis. 
In this fully finite dimensional system, with only $p$ and $q$ as variables, how shall we proceed to prove this minimizer? No sure how to do that now\dots
}

The problem defined by \eqref{E_sm-def_p} yields the following equations for
selective metarmorphosis for landmarks:
\begin{align}
  \begin{split}
  \dot{\mathbf p}_t &= - \nabla u_t(\mathbf q_t)^T \mathbf p_t - \sum_i \frac12
  \nabla \nu(q_i) |p_i|^2\\ \dot{\mathbf q}_t &= u_t(\mathbf q_t) +
  \nu(q_i)\mathbf p_t \,,
\end{split}
  \label{eq-m-classic}
\end{align}
whereas the equation for the variable $\mathbf z_t$ is simply 
\begin{align}
  \dot  {\mathbf z}_t&= \nabla u(\mathbf q_t)^T \mathbf z_t\,, 
\end{align}

Note that if $\nu(x)=0$ in parts of the domain, the dynamics will follow
the standard LDDMM landmark dynamics. This can also be seen in the relation 
\eqref{zp_relation}, where $\nu(x)=0$  implies that $z_t=0$, this the template
does not move. 

Notice that these equations are Hamiltons equation for the Hamiltonian, or
energy density function written in term of $\mathbf p_t$ and $\mathbf q_t$
\begin{align}
  h(\mathbf q, \mathbf p) = h_l(\mathbf q_t, \mathbf p_t)+ \frac12 \sum_i \nu(q_i) |p_i|^2\,,  
\end{align}
thus the metamorphosis term act as a local correction to the kinetic energy. 

The goal of this work is to infer the unknown function $\nu$ so as to gather
information about where in the spatial domain we are most likely to observe
metamorphic behaviour via a Bayesian framework as in \cite{dashti2017bayesian}.

\begin{theorem}
  Equation well-posed, \dots see appendix. 
\end{theorem}

\section{Bayesian Framework}\label{sec:bayesian}

We now place a stochastic model on $\nu$, the purpose of which depends on its
definition as mentioned in remark \eqref{remark:nu}. The goal is to develop an
algorithm to infer $\nu$, passing via the deterministic problem seen above.\\

First we present some preliminaries on the Bayesian approach to inverse problems
in section \ref{subs:gf}, essentially quoting results from
\cite{dashti2017bayesian}.  See also \cite{cotter2013mcmc} for an exposition of
algorithmic aspects of function space MCMC. Section \ref{subs:finite-dim-param}
then describes how we apply this stochastic approach to inverse problems to
$\nu$ by a finite-dimensional family of parameterisations.

\subsection{General Framework}\label{subs:gf}

The general framework is based off of the idea that we can cast optimisation
problems in a probabilistic framework where minimisers, roughly speaking,
correspond to modes of a certain distribution of function space.  In the context
of optimisation we define a \emph{likelihood} $\Phi : X\rightarrow Y$, mapping
some control variable in $X$ to an observable in $Y$.  A \emph{maximum a
posteriori} (MAP) estimator $f^*$ satisfies $f^* \arg\max_{f\in X} \Phi(f) p(f)$
where $p$ is a density over $X$. Equipped with a norm $\|\cdot\|_X$ we can then
define the density by $p(\cdot) \propto e^{-\|\cdot\|_X^2}$.  Supposing further
that the likelihood is on the form $\Phi(f) = -\|f-\lambda\|_Y^2$ then, at least
formally, the MAP estimator minimises $J =\|f^*\|_X^2 + \|f^*-\lambda\|_Y^2$.\\

In general, for inverse problems on function space, several key properties
documented in \cite{?} must be verified before the inverse-problem is
well-posed. Beyond showing existence of the MAP estimator minimising $J$ above,
the infinite-dimensional version of Bayes' rule must also be check i.e. the
Radon-Nikodym derivative of the prior with respect to the posterior must exist
and be absolutely continuous. Finally, we request continuity of the posterior
distribution w.r.t the initial data corresponding in a sense to Hadamard
well-posedness in a probabilistic framework. Proceeding bona fide we therefore
have the key ingredients necessary to define a MCMC algorithm
\cite{cotter2013mcmc}:
\begin{enumerate}
\item Initialise $k \gets 0;\; f^0 \in X;\; \alpha \in (0,\,1)$ 
\item Sample $f\in X$
\item Accept $f^{k+1} \gets \alpha f + (1-\alpha) f^k$ with probability
$a(f^{k+1}, f^k)$ else $f^{k+1} \gets f^k$
\item $kÂ \gets k + 1$
\end{enumerate}
where we implement the acceptance probability as $\min(1, e^{-J^{k+1} +
J^k})$.

\textbf{$\longrightarrow$ Finish}\\

% Talk about our problem
\subsection{Finite-dimensional Parameterisation}\label{subs:finite-dim-param}

We now introduce the main problem of this paper in the setting above. We
consider $\nu$ as a random variable, indeed a random \emph{function}, occupying
some space yet to be determined. This is an appropriate framework because if the
lack of uniqueness allows for a qualitative evaluation of a solution to
selective metamorphosis. We consider the case where $\nu$ is given by a sum of
exponentials:
\begin{equation}
    \nu_h (x) = \sum_{k=1}^K e^{ -\sigma_\nu^{-2}\|h_k - x\|_{\Rd}^2}
\end{equation}
Here the finite family $h_k$ of centroids in $\Rd$ together with the uniform
length-scale $\sigma_\nu$ fully determine $\nu_h$, thus greatly reducing the
complexity of sampling. We defer sampling from function space to future work
\cite{.}. Defining a density $p_{sm} \propto e^{- E_{sm}^\nu}$ over the space of
selective metamorphoses for a prescribed $\nu$ leading to the following MCMC
algorithm:
{\color{red} Are you doing the pCN algorithm  of \cite{cotter2013mcmc} with the 
$\beta$ paramter? They have $\sqrt{1-\beta^2}$ instead of $1-\beta$, does this matter?}
\newcommand{\mhsample}{\textsc{sampleCentroid}}
\newcommand{\acceptprob}{\textsc{accept}}
\begin{algorithm}[h!]
\begin{algorithmic}
\caption{MCMC for selective metamorphosis}\label{algo:mcmc}
\Procedure{mcmcSM}{$N$, $K$, $q_0$, $q_1$, $\beta\in (0,1]$}
\State $j \gets 1$
\State $\nu^j \gets \text{initial guess in } \RdK$
\State Solve \eqref{?} with $\nu^j$ and $q_0,\,q_1$ to obtain $w^0 = (q^0,\, z^0,\, u^0)$
\While{$j \leq N$}
\State Sample a random point $\xi \in \mathcal N(0, \text{Id}_{\mathbb R^d})$
\State $\nu \gets \beta \xi + (1-\beta) \nu^j$
\State Solve \eqref{?} with $\nu$ and $q_0,\,q_1$ to obtain $w = (q,\, z,\, u)$
\If {\textsc{randomUnit()}$\,< \min(1,\, e^{- E_{sm}^{\nu^j}(w^j) + E_{sm}^{\nu}(w)})$}
    \State $\nu^{j+1} \gets \nu$
\Else
    \State $\nu^{j+1} \gets \nu^j$
\EndIf
\State $j\gets j+1$
\EndWhile
\Return $\{\nu^j,\, q^j,\, z^j,\, u^j\}_{j=1}^N$
\EndProcedure
\end{algorithmic}
\end{algorithm}

The numerical solutions to the equations \eqref{?} are obtained using Theano
\cite{team2016theano} which automatically generates the discrete adjoint
equation used to shoot for the final conditions. The next section shows the
algorithm above in practice.

\section{Numerical examples}\label{sec:numerical}

This penultimate section displays some numerical results for our method. First,
as a proof of concept 
%Stuff that works:
%\begin{tabular}{ l c r }
%\text{Test case}   & \beta \text{ (pCN) } & \text{Samples} \\
%\text{Criss-cross} & & \\ <-- CENTROID
%\text{Triangle}    & & \\
%\text{Pringle}     & & \\
%\text{Squeeze}     & 1 & 500 <-- CENTROID
%\end{tabular}

As we have seen in figure \ref{fig:mm_lddmm}, classic metamorphosis is an
appropriate model for non-diffeomorphic matching. We now evaluate our stochastic
model described in algorithm \ref{algo:mcmc} to the landmark configurations in
\ref{fig:mm_lddmm}.

\begin{figure}
\centering
\begin{minipage}{\textwidth}
  \centering
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\\[0.25cm]
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}
    %\subcaption{.}
    \caption{Selective metamorphosis for the inverted landmarks example The top
    row displays the geodesics corresponding a sample realisation from the
    chain, centroid heat map with four MAP estimators, functional histogram and
    autocorrelation plot. The bottom row shows the geodesics for four MAP
    estimators.}
    \label{fig:selective:crisscross}
\end{minipage}
\end{figure}
\begin{figure}
\centering
\begin{minipage}{\textwidth}
  \centering
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\\[0.25cm]
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}
    %\subcaption{.}
    \caption{Selective metamorphosis for the pinch example. The top row displays
    the geodesics corresponding a sample realisation from the chain, centroid
    heat map with four MAP estimators, functional histogram and autocorrelation
    plot. The bottom row shows the geodesics for four MAP estimators.}
    \label{fig:selective:pinch}
\end{minipage}
\end{figure}

\textbf{$\longrightarrow$ Explain results}\\

\begin{figure}
\centering
\begin{minipage}{\textwidth}
  \centering
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\\[0.25cm]
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}\quad
    \includegraphics[width=.2\textwidth]{example-image-a}
    %\subcaption{.}
    \caption{Selective metamorphosis for the inverted landmarks example. The top
    row displays the geodesics corresponding a sample realisation from the
    chain, centroid heat map with four MAP estimators, functional histogram and
    autocorrelation plot. The bottom row shows the geodesics for four MAP
    estimators.}
    \label{fig:selective:triangle}
\end{minipage}
\end{figure}

% Insert Effective Sample size (if time)
We note that since the Euler-Lagrange equations for $p$ and $q$ are
time-reversible, the configuration in both lead to a notion of
collapse and hole creation for the landmarks.\\



We note that the source code for all of these experiments is documented
here (insert link to github.io). 

\section{Outlook}\label{sec:outlook}

{\color{red} Nice sentence:} {\color{blue} This could provide a
first-order exploratory tool for physicians, to see if the development of a
biological feature stems from a few violations of diffeomorphic evolution.}


%Another choice is 
%\begin{align}
%    l(q,p) = \|u\|_B^2 + \sum_i p_i\cdot \nu(q_i) \, , 
%\end{align}
%where $\nu:\mathbb R^2 \to \mathbb R^2$, which will give more freedom on the
%metamorphosis term, and give equations of motion as \begin{align}
%    \dot p_i  &= \nabla u(q_i)p_i  + p_i \cdot \nabla \nu(q_i)\\
%    \dot q &= u(q_i) + \nu(q_i) 
%\end{align}

{\color{red} We should say that this paper is a first step toward image matching, 
with topological features such as growth, etc\dots}

Future work also includes extending this framework to images e.g. using the
kernel framework in \cite{richardson2016metamorphosis}, or developing a
space-time method. Formalising the measure-theory necessary to consider the
limit of ? as $k\rightarrow\infty$.\\

Natural extensions of this work include fully determining e.g. the Fourier modes
of $\nu$ via the MCMC framework.\\

Moreover, adding a time-dependency to $\nu$ is also to be explored. It is our
hope that we can extend the theory developed here to encompass classic
metamorphosis; that is to say, to develop the necessary theory in order to place
a stochastic model on the state space consisting of velocities and source
functions. Being able to sample random pairs (MCMC) of these would permit a
novel numerical approach to metamorphosis as well as other problems shape
analysis.

\appendix

\section{Proof of Theorem \ref{sm-eu}}\label{app:proof:sm-eu}
Clearly the functional in \eqref{E_sm-def} is not convex, so we work with a
reformulation to ensure the required weak lower semi-continuity. Note that
we cannot do a change of variables using $p_t$ since
$\frac{1}{\nu(q_t)}|z_t|^2 = \nu(q_t) |p_t|^2$ and we still have a
non-convexity to deal with. We define a variable $w^i_t = z^i_t
\sqrt{\nu(q_t^i)}$ in the problem:
\begin{align}
\inf_{\substack{u \in L^2([0,1],V)\\ q, w\, \in H^1([0,1],\RdM)}}
    & S = \int_0^1 \half\vnorm{u_t}^2 + \half\sum_i |w_t^i|^2 \diff{t}\\
    & \dot{q_t^i} = u(q_t^i) + \sqrt{\nu(q_t^i)} w^i_t\\
    & q_0,\,q_1\text{ fixed}
  \label{pbl:reformulation}
\end{align}

We now show existence of a minimiser to this problem. First, note that owing to
the constraint effectively being a boundary value problem, we cannot always find
a $q$ for arbitrary pairs of $(u,\,w)$. We define an bounded operator
$(q,u)\mapsto frac{\dot{q} - u(q)}{\sqrt{\nu(q)}} := w$:
\begin{align*}
\ltwonorm{w}^2 & = \ltwonorm{\frac{\dot{q} - u(q)}{\sqrt{\nu(q)}}}^2\\
& \leq \nuinf^{-1}\Big(\ltwonorm{\dot{q}}^2 + \ltwonorm{u(q)}^2\Big)\\
\end{align*}
which is clearly bounded since $q\in C^1(0,1,H)$ and since by continuity of $u$.
From this we generate a minimising sequence $(q^n, u^n, w^n)$ admissible to
\eqref{pbl:reformulation}.\\

\textbf{$\longrightarrow$ Show weak continuity of the constraint equation for
$q$ (the stuff below)}\\

Passing to subsequences where necessary we can by classic results
\cite{younes2010shapes} extract bounded subsequences converging to weak limits
where necessary to obtain a minimiser. Convexity of $S$ implies the necessary
weak lower semi-continuity concluding the proof.

%\begin{theorem}[Optimality Conditions]
%There exists a unique (? )solution $u, q, z$ to this system.
%This will give more conditions on $\nu$, like $\nu(x) \in C^{1}(\mathbb R^2)$. 
%\end{theorem}

\section{Well-posedness of the equation of motion}
Using the equation for $z$, we can formally write $z_t = z_t \circ \varphi^{-1}$,
which corresponds to writing the initial $z_0(x) = \sum_i z_0^i\delta(x-x_0^i)$, 
and the time dependent solution $z_t(x) = \sum_i z_0^i\delta(x-q_t^i)$ (see 
\cite{holm2009euler}[sec 11.2] for more details). Together with the relations 
\eqref{q_t} and \eqref{z_eta} and $\eta_0 = q_0$ as $\varphi_0 = Id$, we can write
\begin{align*}
  \mathbf q_t &= \varphi_t \eta_t\\
   &= \varphi_t \mathbf q_0 + \varphi_t \eta_t-\varphi_t \eta_0\\
   &= \varphi_t \mathbf q_0 + \varphi_t \int \dot \eta_t dt\\
   &= \varphi_t \mathbf q_0 + \varphi_t \int \varphi_t^{-1} \varphi_t\dot \eta_t dt\\
   &= \varphi_t \mathbf q_0 + \varphi_t \int  \varphi_t^{-1}\mathbf z dt \\
   &= \varphi_t \mathbf q_0 + \varphi_t \int  \varphi_t^{-1}\nu(\mathbf q_t) \mathbf p_t  dt\\
   &= \varphi_t \mathbf q_0 + \varphi_t \int  \varphi_t^{-1}\mathbf z_0\circ \varphi_t^{-1} dt\, , 
\end{align*}
and directly verify that it satisfy the equation of motions by computing
\begin{align*}
  \dot {\mathbf q}_t = \dot \varphi_t \varphi_t^{-1} \varphi \mathbf q_0 + \dot
  \varphi_t \varphi_t^{-1} \varphi_t \eta_t + \varphi_t \dot \eta_t  = u_t(
  \mathbf q_t) + \mathbf z_t\, ,
\end{align*}
using $\dot \varphi_t\varphi_t^{-1} = u_t$. 
This is the integral form of the equation of motion, which is the same equation
as in \cite{holm2009euler}[eqn 19], with the only difference in the term $\nu(q) p_i$ 
in the reconstruction relation. 
{\color{red} Can we simply redo the same proof, but being careful when they need this term, 
and make sure that $\nu(x)<\nu_{max}$ is enough? maybe the derivative needs to be smooth, too. }

\bibliographystyle{abbrv}
\bibliography{landmarks}
\end{document}
